# 山西电力交易平台爬虫脚本提示词

## 1. 爬虫目标

开发一个自动化爬虫脚本，用于爬取**山西电力交易平台**电力现货市场信息披露网站上的所有表格数据。

**目标网站基础信息：**
- **URL：** `https://pmos.sx.sgcc.com.cn/#/dashboard`
- **平台名称：** 山西电力交易中心 电力交易平台（SXPX）
- **应用类型：** 单页应用（SPA），使用 hash 路由 `#/dashboard`

### 1.1 现货出清结果
- 实时市场出清概况
- 日前市场出清概况
- 日前备用总量

### 1.2 现货实时数据
- 实时各时段出清现货电量
- 实时备用总量
- 实时节点边际电价
- 实时输电断面约束及阻塞
- 断面约束情况及影子价格
- 重要通道实际输电情况

### 1.3 现货日前信息
- 抽蓄电站水位
- 断面约束
- 日前联络线计划
- 输变电设备检修计划
- 输电通道可用容量
- 日前机组开机安排
- 日前节点边际电价

### 1.4 综合查询 - 供需与约束 - 参数信息
- 节点分配因子

**导航路径说明：**
- 左侧栏：信息披露 > 现货出清结果/现货实时数据/现货日前信息/综合查询
- 综合查询下的「节点分配因子」路径：综合查询 > 供需与约束 > 参数信息 > 节点分配因子
- 需支持**展开折叠菜单**以访问各子分类

---

## 2. 爬虫功能要求

### 2.1 数据获取

#### 2.1.1 浏览器与访问
- 使用 **Chrome** 进行网页访问和操作
- 处理单页应用（SPA）的动态加载，在导航、筛选、查询后增加显式等待

#### 2.1.2 导航与筛选
- 通过左侧栏及内容区子菜单自动定位并访问各数据类别页面
- 处理所有筛选条件：
  - **日期**：`YYYY-MM-DD` 格式，绝大多数页面仅支持**单日期**选择
  - **下拉选项**（按页面）：
    - 断面名称：实时输电断面约束及阻塞、断面约束情况及影子价格、重要通道实际输电情况
    - 节点名称：实时节点边际电价、日前节点边际电价
    - 机组名称：日前机组开机安排
    - 联络线名称：日前联络线计划
    - 通道名称：输电通道可用容量
    - 每页条数：断面约束、输变电设备检修计划、输电通道可用容量（如 10/20/30/40/50）

#### 2.1.4 日期范围处理（重要）
- 配置日期范围：默认 2025-01-01 至当前日期
- **【关键】** 因多数页面仅有单日期选择，需实现**按日迭代**：在指定日期区间内逐日设置日期并点击查询，以覆盖整段时间

#### 2.1.5 查询与导出
- 设置好筛选条件后，自动点击「查询」按钮
- **【优先】** 若页面提供「原样导出」或「导出」按钮，**优先使用该功能**获取数据（可能为 CSV/Excel），以简化分页和解析逻辑
- 部分页面为「原样导出」（如日前备用总量、断面约束等），部分为「导出」（如日前机组开机安排、日前节点边际电价），均需支持
- 若导出不可用或不符合需求，则通过 HTML 表格解析获取数据

#### 2.1.6 分页与滚动
- 支持分页控件：首页、上一页、下一页、末页
- 部分表格仅有竖向滚动条，需处理**滚动加载**或一次性加载大量行的情况
- 可通过「每页条数」下拉尽量增大单页条数，减少翻页次数

#### 2.1.7 调度与反爬
- 支持可配置的爬取频率（如每日、每小时等）
- 合理控制请求间隔，遵守 robots.txt，避免对目标站点造成过大压力

### 2.2 数据提取

#### 2.2.1 表格解析
- 准确识别表格元素（含表头与数据行）
- 提取表头与所有数据字段
- 处理不同页面表格结构差异（列名、列数不同）

#### 2.2.2 特殊数据格式
- **出清概况类（实时/日前市场出清概况）**：  
  「出清概况」列为长文本，如「02月04日直调用电实际最大负荷3709.87万千瓦...」，需：
  - 使用正则或结构化解析拆分各指标（负荷、电价、机组数等）
  - 提取单位（MW、MWh、元/MWh、元）并在数据中保留或标注
  - 定义并记录各指标的字段名和提取规则

#### 2.2.3 各页面表格结构示例（供参考）

| 数据类别 | 典型列 |
|---------|--------|
| 实时各时段出清现货电量 | 序号, 日期, 时点, 出清现货电量(MWh) |
| 实时备用总量 | 序号, 日期, 上旋最小值(MW), 下旋最小值(MW) |
| 日前备用总量 | 序号, 日期, 上旋最小值(MW), 下旋最小值(MW) |
| 实时节点边际电价 | 序号, 节点名称, 日期, 时点, 电能量价格, 阻塞价格, 节点电价(元/MWh) |
| 日前节点边际电价 | 序号, 节点名称, 日期, 时点, 电能量价格(元/MWh), 阻塞价格(元/MWh), 节点电价(元/MWh) |
| 实时输电断面约束及阻塞 | 序号, 断面名称, 日期, 时点, 是否越限 |
| 断面约束情况及影子价格 | 序号, 断面名称, 日期, 时点, 阻塞价格(元/MWh) |
| 重要通道实际输电情况 | 序号, 断面名称, 日期, 时点, 潮流(MW) |
| 抽蓄电站水位 | 序号, 日期, 描述, 值(m) |
| 断面约束 | 序号, 日期, 断面名称, 断面描述, 正向传输极限(MW), 反向传输极限(MW) |
| 日前联络线计划 | 序号, 通道, 日期, 时点, 电力值(MW) |
| 输变电设备检修计划 | 序号, 日期, 设备名称, 设备类型, 开始时间, 结束时间 |
| 输电通道可用容量 | 序号, 通道名称, 日期, 时点, 可用容量(MW) |
| 日前机组开机安排 | 序号, 机组名称, 日期, 时点, 开停状态（如：开机/停机） |
| 节点分配因子 | 序号, 日期, 时段, 节点名称, 分配因子 |

### 2.3 数据处理
- 清洗和规范化提取的数据
- 处理数据类型转换（数字、日期、文本）
- 处理缺失值和异常值
- 必要时计算衍生指标
- 记录「最新更新日期」字段，用于增量更新判断

### 2.4 数据存储
- 以 **CSV** 格式存储
- 文件命名：`{数据类别}_{日期}_{其他筛选条件}.csv`  
  例：`实时节点边际电价_2026-02-05_节点1206008004.csv`、`日前机组开机安排_2026-02-05_220kV思安光伏电站.csv`
- 保证存储结构一致，便于追溯与增量更新
- 按类别建立子目录，便于管理与查询

### 2.5 错误处理与日志
- 异常捕获与分类（网络、解析、数据提取等）
- 详细日志（时间、页面、操作、错误信息）
- 自动重试（可配置次数与间隔）
- 异常告警（可选：邮件、webhook 等）

---

## 3. 技术要求

- **语言：** Python
- **浏览器控制：** Selenium 或 Playwright + Chrome
- **解析库：** BeautifulSoup、lxml 等
- **动态内容：** 支持等待元素、网络空闲等
- **配置：** 支持配置文件（爬取参数、日期范围、执行频率等）
- **架构：** 模块化设计，便于维护与扩展

---

## 4. 其他要求

- 遵守 robots.txt
- 控制爬取频率，避免对网站造成压力
- 提供使用说明和示例
- 支持多线程或异步爬取以提升效率
- 提供数据质量检查与校验功能（如必填字段、数值范围、日期连续性等）

---

## 5. 输出格式

- 爬虫脚本代码
- 配置文件示例（执行频率、日期范围、各类别爬取开关等）
- 使用说明文档
- 数据存储示例结构及 CSV 命名示例

---

## 6. 补充说明

### 6.1 页面共性
- 顶部显示单位：MW, MWh, 元/MWh, 元
- 部分页面展示「最新更新日期」，可用于增量更新
- 多数页面含「原样导出」或「导出」按钮，可优先作为数据源（如日前备用总量为「原样导出」，日前机组开机安排、日前节点边际电价为「导出」）

### 6.2 分页情况
- 断面约束：多页（如 31 页），需处理分页
- 输变电设备检修计划、输电通道可用容量：有分页
- 日前备用总量：通常单日单行，无分页
- 日前机组开机安排、日前节点边际电价：可能有滚动条或分页
- 其他部分页面可能仅有滚动条，无分页控件

### 6.3 下拉筛选策略
- 对有下拉的页面（断面名称、节点名称、机组名称、联络线名称、通道名称），需：
  - 获取所有选项
  - 按需全量爬取或按配置选择部分选项
  - 选项变化时能自动适配
